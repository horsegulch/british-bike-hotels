### Overall Difficulty Calculation Flow (v2 - Linear UF)

This document outlines the step-by-step process by which the `Total_Difficulty` score for a cycling route is calculated, integrating the Distance Difficulty and the Elevation Factor (EF). The final score is **uncapped**.

**Input Data:** The model requires the following raw data for a given route (typically extracted from GPX/TCX/FIT):

1. `distance_km`: Total distance of the route in kilometers.
    
2. `TEGa`: Total Elevation Gain - Ascent (meters) - _Calculated from smoothed data_.
    
3. `ACg`: Average Climb Gradient of significant climb sections (%) - _Calculated from smoothed data_.
    
4. `MCg`: Max Climb Gradient over ~100m segment (%) - _Calculated from smoothed data_.
    
5. `PDD`: Proportion of Distance Downhill (0 to 1) - _Calculated from smoothed data_.
    
6. `ADg`: Average Descent Gradient of significant descent sections (positive value, %) - _Calculated from smoothed data_.
    

**Calculation Steps:**

1. **Handle Zero Distance Edge Case:**
    
    - If `distance_km` is 0 (or less), the `Total_Difficulty` is immediately set to 0.0.
        
2. **Calculate Base Distance Difficulty (`Distance_Difficulty`):**
    
    - Includes a base addition and a quadratic component based on `distance_km`.
        
    - Formula: `Distance_Difficulty = DISTANCE_BASE_ADDITION + (DISTANCE_DIFFICULTY_COEFFICIENT_A * distance_kmÂ²)`
        
    - _Reference: "Current Model Parameters Summary" document._
        
3. **Calculate Elevation Factor (`EF`):** The `EF` modifies the `Distance_Difficulty`.
    
    - `EF = UF * DRF`
        
    - **a. Calculate Uphill Factor (`UF`):**
        
        - Uses a **Linear Model**.
            
        - Normalizes `TEGa`, `ACg`, `MCg` against their respective `max_expected_` values.
            
        - Calculates a weighted `Uphill_Score (US)`.
            
        - Formula: `UF = 1 + (LINEAR_UF_SLOPE * US)`
            
        - _Reference: "Current Model Parameters Summary" document._
            
    - **b. Calculate Downhill Reduction Factor (`DRF`):**
        
        - Checks qualifying conditions based on `PDD`, `TEGa`, and `ADg`.
            
        - If qualified, calculates a `Downhill_Score (DS)` based on normalized `PDD` and `ADg`.
            
        - Formula: `DRF = Max_Downhill_Reduction_Factor ^ DS`
            
        - If not qualified, `DRF = 1.0`.
            
        - _Reference: "Current Model Parameters Summary" document._
            
4. **Calculate Raw Total Difficulty:**
    
    - `Raw_Total_Difficulty = Distance_Difficulty * EF`
        
5. **Apply Minimum Score Floor:**
    
    - The final score is the raw score, but ensured to be not less than the minimum.
        
    - `Total_Difficulty = max(MIN_DIFFICULTY_SCORE, Raw_Total_Difficulty)`
        
    - Current `MIN_DIFFICULTY_SCORE = 0.0`. The score is **uncapped** at the top end.
        

**Output:**

- `Total_Difficulty`: The final, uncapped difficulty score for the route.
    

This flow is implemented in the `calculate_total_difficulty` Python function within the main script (`gpx_difficulty_calculator` document), using metrics generated by `extract_metrics_from_gpx`.